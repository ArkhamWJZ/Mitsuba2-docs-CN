<!-- Based on https://stackoverflow.com/a/25543713/1130282 -->

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>More advanced examples &#8212; mitsuba2 0.1.dev0 documentation</title>
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Integration with PyTorch" href="pytorch.html" />
    <link rel="prev" title="Differentiable rendering" href="diff_render.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pytorch.html" title="Integration with PyTorch"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="diff_render.html" title="Differentiable rendering"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">More advanced examples</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../../index.html" class="text-logo">Mitsuba 2</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/intro.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/cloning.html">Cloning the repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/variants.html">Choosing variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/compiling.html">Compiling the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/file_format.html">Scene file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/differences.html">Differences to Mitsuba 0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Python interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/parsing_xml.html">Parsing XML code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/rendering_scene.html">Rendering a scene</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/bsdf_eval.html">Custom applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Inverse rendering</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="diff_render.html">Differentiable rendering</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">More advanced examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#differentiating-textures">Differentiating textures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pytorch.html">Integration with PyTorch</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/variants_cpp.html">Variants in C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/writing_plugin.html">Plugins &amp; Macros</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/building_documentation.html">Building the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/polarization.html">Polarization</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_topics/custom_plugins.html">Custom plugins in Python</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugin reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugin_reference/intro.html">Plugin reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html">Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#bsdfs">BSDFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#phase-functions">Phase functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#emitters">Emitters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#sensors">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#textures">Textures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#spectra">Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#integrators">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#samplers">Samplers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#films">Films</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#reconstruction-filters">Reconstruction filters</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/core_api.html">Core API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/render_api.html">Render API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/python_api.html">Python API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zz_bibliography.html">Bibliography</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../index.html">Docs</a></li>
              
              <li>More advanced examples</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="more-advanced-examples">
<span id="sec-differentiable-rendering-advanced"></span><h1>More advanced examples<a class="headerlink" href="#more-advanced-examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="differentiating-textures">
<h2>Differentiating textures<a class="headerlink" href="#differentiating-textures" title="Permalink to this headline">¶</a></h2>
<p>The previous example demonstrated differentiation of a scalar color parameter.
We will now show how to work with textured parameters, focusing on the example
of an environment map emitter.</p>
<div class="figure compound align-center" id="fig-bunny-autodiff">
<div style="width: 49%" class="subfigure align-center" id="id1">
<a class="reference internal image-reference" href="../../_images/bunny.jpg"><img alt="../../_images/bunny.jpg" src="../../_images/bunny.jpg" style="width: 95%;" /></a>
<p class="caption"><span class="caption-text">A metallic Stanford bunny surrounded by an environment map.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div style="width: 49%" class="subfigure align-center" id="id2">
<a class="reference internal image-reference" href="../../_images/museum.jpg"><img alt="../../_images/museum.jpg" src="../../_images/museum.jpg" style="width: 95%;" /></a>
<p class="caption"><span class="caption-text">The ground-truth environment map that we will attempt to recover from the image on the left.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div><p id="fig-bunny-autodiff">The example scene can be downloaded <a class="reference external" href="http://mitsuba-renderer.org/scenes/bunny.zip">here</a> and contains a metallic
Stanford bunny surrounded by a museum-like environment. As before, we load
the scene and enumerate its differentiable parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">enoki</span> <span class="k">as</span> <span class="nn">ek</span>
<span class="kn">import</span> <span class="nn">mitsuba</span>
<span class="n">mitsuba</span><span class="o">.</span><span class="n">set_variant</span><span class="p">(</span><span class="s1">&#39;gpu_autodiff_rgb&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">mitsuba.core</span> <span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">mitsuba.core.xml</span> <span class="kn">import</span> <span class="n">load_file</span>
<span class="kn">from</span> <span class="nn">mitsuba.python.util</span> <span class="kn">import</span> <span class="n">traverse</span>
<span class="kn">from</span> <span class="nn">mitsuba.python.autodiff</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">write_bitmap</span><span class="p">,</span> <span class="n">Adam</span>

<span class="c1"># Load example scene</span>
<span class="n">Thread</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span><span class="o">.</span><span class="n">file_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bunny&#39;</span><span class="p">)</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="s1">&#39;bunny/bunny.xml&#39;</span><span class="p">)</span>

<span class="c1"># Find differentiable scene parameters</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">traverse</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</pre></div>
</div>
<p>We then make a backup copy of the ground-truth environment map and generate a
reference rendering</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a backup copy</span>
<span class="n">param_res</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;my_envmap.resolution&#39;</span><span class="p">]</span>
<span class="n">param_ref</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;my_envmap.data&#39;</span><span class="p">])</span>

<span class="c1"># Discard all parameters except for one we want to differentiate</span>
<span class="n">params</span><span class="o">.</span><span class="n">keep</span><span class="p">([</span><span class="s1">&#39;my_envmap.data&#39;</span><span class="p">])</span>

<span class="c1"># Render a reference image (no derivatives used yet)</span>
<span class="n">image_ref</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">crop_size</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">film</span><span class="p">()</span><span class="o">.</span><span class="n">crop_size</span><span class="p">()</span>
<span class="n">write_bitmap</span><span class="p">(</span><span class="s1">&#39;out_ref.png&#39;</span><span class="p">,</span> <span class="n">image_ref</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s now change the environment map into a uniform white lighting environment.
The <code class="docutils literal notranslate"><span class="pre">my_envmap.data</span></code> parameter is a RGBA bitmap linearized into a 1D array of
size <code class="docutils literal notranslate"><span class="pre">param_res[0]</span> <span class="pre">x</span> <span class="pre">param_res[1]</span> <span class="pre">x</span> <span class="pre">4</span></code> (125’000).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change to a uniform white lighting environment</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;my_envmap.data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_ref</span><span class="p">))</span>
<span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, we jointly estimate all 125K parameters using gradient-based
optimization. The optimization loop is identical to previous examples except
that we can now also write out the current environment image in each iteration.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Construct an Adam optimizer that will adjust the parameters &#39;params&#39;</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=.</span><span class="mi">02</span><span class="p">)</span>

<span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Perform a differentiable rendering of the scene</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">write_bitmap</span><span class="p">(</span><span class="s1">&#39;out_</span><span class="si">%03i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">it</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">)</span>
    <span class="n">write_bitmap</span><span class="p">(</span><span class="s1">&#39;envmap_</span><span class="si">%03i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">it</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;my_envmap.data&#39;</span><span class="p">],</span>
                 <span class="p">(</span><span class="n">param_res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Objective: MSE between &#39;image&#39; and &#39;image_ref&#39;</span>
    <span class="n">ob_val</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">hsum</span><span class="p">(</span><span class="n">ek</span><span class="o">.</span><span class="n">sqr</span><span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">image_ref</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Back-propagate errors to input parameters</span>
    <span class="n">ek</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">ob_val</span><span class="p">)</span>

    <span class="c1"># Optimizer: take a gradient step</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># Compare iterate against ground-truth value</span>
    <span class="n">err_ref</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">hsum</span><span class="p">(</span><span class="n">ek</span><span class="o">.</span><span class="n">sqr</span><span class="p">(</span><span class="n">param_ref</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;my_envmap.data&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">%03i</span><span class="s1">: error=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">err_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
<p>The following video shows the convergence behavior during the first 100
iterations. The image rapidly resolves to the target image. The small black
regions in the image correspond to parts of the mesh where inter-reflection was
ignored due to a limit on the maximum number of light bounces.</p>
<center>
    <video controls loop autoplay muted
    src="https:////rgl.s3.eu-central-1.amazonaws.com/media/uploads/wjakob/2020/03/03/bunny_render.mp4"></video>
</center><p>The following image shows the reconstructed environment map at each step.
Unobserved regions are unaffected by gradient steps and remain white.</p>
<center>
    <video controls loop autoplay muted
    src="https://rgl.s3.eu-central-1.amazonaws.com/media/uploads/wjakob/2020/03/03/bunny_envmap.mp4"></video>
</center><p>This image is still fairly noisy and even contains some negative (!) regions.
This is because the optimization problem defined above is highly ambiguous due
to the loss of information that occurs in the forward rendering model above.
The solution we found optimizes the objective well (i.e. the rendered image
matches the target), but the reconstructed texture may not match our
expectation. In such a case, it may be advisable to introduce further
regularization (non-negativity, smoothness, etc.).</p>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="diff_render.html" title="previous chapter (use the left arrow)">Differentiable rendering</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="pytorch.html" title="next chapter (use the right arrow)">Integration with PyTorch</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="pytorch.html" title="Integration with PyTorch"
             >next</a> |</li>
        <li class="right" >
          <a href="diff_render.html" title="Differentiable rendering"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">More advanced examples</a></li> 
      </ul>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>