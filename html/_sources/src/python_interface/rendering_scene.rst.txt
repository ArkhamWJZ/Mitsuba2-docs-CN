.. _sec-rendering-scene:

æ¸²æŸ“åœºæ™¯
=================

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä» XML æ–‡ä»¶ä¸­åŠ è½½åœºæ™¯ã€‚ä¸€æ—¦åœºæ™¯åŠ è½½å®Œæ¯•ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼å¼€å§‹æ¸²æŸ“åœºæ™¯äº†ï¼š

.. code-block:: python

    ...

    # Load the scene for an XML file
    scene = load_file(filename)

    # Get the scene's sensor (if many, can pick one by specifying the index)
    sensor = scene.sensors()[0]

    # Call the scene's integrator to render the loaded scene with the desired sensor
    scene.integrator().render(scene, sensor)

æ¸²æŸ“å®Œæˆåï¼Œå¯ä»¥å°†æ¸²æŸ“æ•°æ®å†™å‡ºä¸º HDR OpenEXR æ–‡ä»¶ä¸­ï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

.. code-block:: python

    # The rendered data is stored in the film
    film = sensor.film()

    # Write out data as high dynamic range OpenEXR file
    film.set_destination_file('/path/to/output.exr')
    film.develop()

è¿˜å¯ä»¥ä½¿ç”¨ :py:class:`mitsuba.core.Bitmap` ç±»ï¼Œå°†ç›¸åŒçš„æ¸²æŸ“æ•°æ®ç»è¿‡ gamma tone-mapped è°ƒæ•´è¾“å‡ºä¸º JPEGã€‚

.. code-block:: python

    # Write out a tone-mapped JPG of the same rendering
    from mitsuba.core import Bitmap, Struct
    img = film.bitmap(raw=True).convert(Bitmap.PixelFormat.RGB, Struct.Type.UInt8, srgb_gamma=True)
    img.write('/path/to/output.jpg')

:code:`film.bitmap()` ä¸­çš„ ``raw=True`` å‚æ•°æŒ‡å®šäº†æˆ‘ä»¬æ˜¯å¯¹åŸå§‹èƒ¶ç‰‡çš„å†…å®¹æ„Ÿå…´è¶£ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ‰§è¡Œå‡ºæˆ‘ä»¬æ‰€éœ€è½¬æ¢çš„æ ¼å¼ã€‚

æ›´å¤šæœ‰å…³ bitmap è½¬æ¢çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… :py:meth:`mitsuba.core.Bitmap.convert`ã€‚

å¯ä»¥å°†å‚¨å­˜åœ¨ ``Bitmap`` å¯¹è±¡ä¸­çš„æ•°æ®è½¬æ¢æˆ NumPy æ•°ç»„ï¼Œä»¥ä¾¿ä»¥ååœ¨ Python ä¸­è¿›ä¸€æ­¥å¤„ç†ã€‚

.. code-block:: python

    # Get linear pixel values as a NumPy array for further processing
    img = img.convert(Bitmap.PixelFormat.RGB, Struct.Type.Float32, srgb_gamma=False)
    import numpy as np
    image_np = np.array(img)
    print(image_np.shape)

.. note::

    æœ¬ç¤ºä¾‹çš„å®Œæ•´ Python è„šæœ¬å¯ä»¥åœ¨è¯¥æ–‡ä»¶ä¸­æ‰¾åˆ°ğŸ‘‰ï¼š:file:`docs/examples/01_render_scene/render_scene.py`
    


.. _sec-rendering-scene-custom:

Custom rendering pipeline in Python
------------------------------------

åœ¨æ¥ä¸‹æ¥çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Python ç»‘å®šç¼–å†™ä¸€ä¸ªç®€å•çš„æ·±åº¦å›¾æ¸²æŸ“å™¨ï¼Œè¿™ä¸ªæ¸²æŸ“å™¨ä¼šåŒ…æ‹¬å…‰çº¿ç”Ÿæˆå’Œ
åƒç´ å€¼ splat æŠ€æœ¯ï¼Œæ•´ä¸ªå®Œå…¨æ˜¯ç”± Python ç¼–å†™çš„ã€‚æ˜¾ç„¶è¿™æ¯”ç›´æ¥è°ƒç”¨ä¸€ä¸ª ``render()`` é›†æˆå™¨ä¼šéº»çƒ¦çš„å¤šï¼Œ
ä½†è¿™ç§ç»†é¢—ç²’åº¦çš„å·¥ä½œåœ¨æŸäº›åº”ç”¨ä¸­å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚æ›´å¤šä¿¡æ¯è¯·å‚é˜…ç›¸å…³æ–‡æ¡£ :ref:`developing custom plugins in Python <sec-custom-plugins>`ã€‚

ä¸ä¹‹å‰ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯¼å…¥ä¸€äº›æ¨¡å—å¹¶ä»ç£ç›˜ä¸­åŠ è½½åœºæ™¯ï¼š

.. literalinclude:: ../../examples/02_depth_integrator/depth_integrator.py
   :language: python
   :lines: 1-21

åœ¨æœ¬ä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Mitsuba çš„ packet å˜ä½“ã€‚è¿™æ„å‘³ç€ Mitsuba å‡½æ•°çš„æ‰€æœ‰è°ƒç”¨éƒ½æ˜¯çŸ¢é‡åŒ–çš„ï¼Œå¹¶ä¸”
æˆ‘ä»¬åœ¨ Python ä¸­é¿å…æ˜‚è´µçš„ for å¾ªç¯ã€‚åŒæ ·çš„ä»£ç ä¹Ÿå¯ä»¥è·‘åœ¨ `gpu` æ¨¡å¼çš„æ¸²æŸ“å™¨ä¸Šã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ‰‹åŠ¨è·Ÿè¸ªç©¿è¿‡å›¾åƒä¸Šæ¯ä¸ªåƒç´ çš„å…‰çº¿ï¼Œè€Œä¸æ˜¯åƒä»¥å‰é‚£æ ·ç›´æ¥è°ƒç”¨åœºæ™¯ä¸Šçš„ç°æˆé›†æˆå™¨ã€‚

.. literalinclude:: ../../examples/02_depth_integrator/depth_integrator.py
   :language: python
   :lines: 23-57

åœ¨è®¡ç®—å®Œæ‰€æœ‰å…‰çº¿ä¸æ›²é¢çš„äº¤ç‚¹åï¼Œæˆ‘ä»¬å¼€å§‹æå–æ·±åº¦å€¼ï¼š

.. literalinclude:: ../../examples/02_depth_integrator/depth_integrator.py
   :language: python
   :lines: 59-64

éšåæˆ‘ä»¬å°†è¿™äº›æ·±åº¦å€¼æ±‡é›†ï¼ˆsplatï¼‰æˆ :code:`ImageBlock` ï¼Œè¿™æ˜¯ä¸€ä¸ªèƒ½å¹³å‡å‘¨å›´é‡‡æ ·ç‚¹å’Œè§£é‡Šåƒç´ æ»¤æ³¢å™¨çš„æ•°æ®ç»“æ„ã€‚
éšå :code:`ImageBlock` è¢«è½¬åŒ–æˆ :code:`Bitmap` å¯¹è±¡å¹¶å°†ç»“æœå›¾åƒä¿å­˜åˆ°ç£ç›˜ä¸Šã€‚

.. literalinclude:: ../../examples/02_depth_integrator/depth_integrator.py
   :language: python
   :lines: 66-84

.. note:: å¯ä»¥ä» :code:`docs/examples/02_depth_integrator/depth_integrator.py` æ‰¾åˆ°æœ¬ä¾‹çš„ä»£ç ã€‚
