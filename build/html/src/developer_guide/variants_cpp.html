<!-- Based on https://stackoverflow.com/a/25543713/1130282 -->

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Variants in C++ &#8212; mitsuba2 0.1.dev0 documentation</title>
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Plugins &amp; Macros" href="writing_plugin.html" />
    <link rel="prev" title="Introduction" href="intro.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="writing_plugin.html" title="Plugins &amp; Macros"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Variants in C++</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../../index.html" class="text-logo">Mitsuba 2</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/intro.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/cloning.html">Cloning the repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/variants.html">Choosing variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/compiling.html">Compiling the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/file_format.html">Scene file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/differences.html">Differences to Mitsuba 0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Python interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/parsing_xml.html">Parsing XML code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/rendering_scene.html">Rendering a scene</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/bsdf_eval.html">Custom applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Inverse rendering</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/diff_render.html">Differentiable rendering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/advanced.html">More advanced examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/pytorch.html">Integration with PyTorch</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Variants in C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_plugin.html">Plugins &amp; Macros</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_documentation.html">Building the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="polarization.html">Polarization</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_topics/custom_plugins.html">Custom plugins in Python</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugin reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugin_reference/intro.html">Plugin reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html">Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#bsdfs">BSDFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#phase-functions">Phase functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#emitters">Emitters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#sensors">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#textures">Textures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#spectra">Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#integrators">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#samplers">Samplers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#films">Films</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#reconstruction-filters">Reconstruction filters</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/core_api.html">Core API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/render_api.html">Render API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/python_api.html">Python API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zz_bibliography.html">Bibliography</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../index.html">Docs</a></li>
              
              <li>Variants in C++</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="variants-in-c">
<span id="sec-variants-cpp"></span><h1>Variants in C++<a class="headerlink" href="#variants-in-c" title="Permalink to this headline">¶</a></h1>
<p>As described in the section on <a class="reference internal" href="../getting_started/variants.html#sec-variants"><span class="std std-ref">choosing variants</span></a>, Mitsuba
2 code can be compiled into different variants, which are parameterized by
their computational backend and representation of color. To enable such
retargeting from a single implementation, the system relies on C++ templates
and metaprogramming. Indeed, most C++ classes and functions in Mitsuba 2 are
templates with the following two type parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Float</span></code> and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Spectrum</span></code>.</p></li>
</ul>
<p>These two parameters exactly correspond to the previously mentioned computational
backend and color representation. During compilation, Mitsuba’s build system reads
the <code class="docutils literal notranslate"><span class="pre">mitsuba.conf</span></code> file and substitutes the types of selected variants into these
template parameters. For example,</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&quot;scalar_rgb&quot;: {
    &quot;float&quot;: &quot;float&quot;,
    &quot;spectrum&quot;: &quot;Color&lt;Float, 3&gt;&quot;
},
</pre></div>
</div>
<p>causes an
<a class="reference external" href="https://en.cppreference.com/w/cpp/language/class_template#Explicit_instantiation">explicit template instantiation</a>
with</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Float</span>    <span class="o">=</span> <span class="kt">float</span><span class="p">;</span>
<span class="n">Spectrum</span> <span class="o">=</span> <span class="n">Color</span><span class="o">&lt;</span><span class="n">Float</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>The resulting C++ symbols will be added to the shared libraries
(<code class="docutils literal notranslate"><span class="pre">dist/libmitsuba-core.so</span></code>, <code class="docutils literal notranslate"><span class="pre">dist/libmitsuba-render.so</span></code>,
<code class="docutils literal notranslate"><span class="pre">dist/plugin/*.so</span></code>, …). At runtime, the user-specified variant will
determine the set of symbols to be used by the renderer.</p>
<div class="section" id="type-aliases">
<h2>Type aliases<a class="headerlink" href="#type-aliases" title="Permalink to this headline">¶</a></h2>
<p>Of course, <code class="docutils literal notranslate"><span class="pre">Float</span></code> and <code class="docutils literal notranslate"><span class="pre">Spectrum</span></code> are not the only types that are used in a
renderer. It also access to integer arithmetic types, vectors, normals, points,
rays, matrices, and so on. More complex data structures like intersection and
sampling records are also commonly used.</p>
<p>It would be tedious to have to define these types in the context of a given
variant. To facilitate this process, Mitsuba provides a helper macro to import
suitable types that are inferred from the definition of <code class="docutils literal notranslate"><span class="pre">Float</span></code> and
<code class="docutils literal notranslate"><span class="pre">Spectrum</span></code>.</p>
<p>For example, after evaluating this macro at the beginning of a templated
function, we are then able to use other templated Mitsuba types (e.g.
<code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">Vector2f</span></code>, <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">Ray3f</span></code>, <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">SurfaceInteraction</span></code>, …) as if they were not templated.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Float</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">Spectrum</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">my_function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">/// Import type aliases (e.g. using Vector3f = Vector&lt;Float, 3&gt;;)</span>
    <span class="n">MTS_IMPORT_TYPES</span><span class="p">()</span>

    <span class="c1">// Can now use those types as if they were not templated</span>
    <span class="n">Point3f</span> <span class="n">p</span><span class="p">(</span><span class="mf">4.f</span><span class="p">,</span> <span class="mf">3.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
    <span class="n">Vector3f</span> <span class="nf">v</span><span class="p">(</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
    <span class="n">Ray3f</span> <span class="nf">ray</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ray</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MTS_VARIANT</span></code> macro is often used as a shorthand notation instead of
the somewhat verbose <code class="docutils literal notranslate"><span class="pre">template</span> <span class="pre">&lt;typename</span> <span class="pre">Float,</span> <span class="pre">typename</span> <span class="pre">Spectum&gt;</span></code>.</p>
</div>
<p>Those macros are described in more detail in the next chapter:</p>
<ul class="simple">
<li><p><a class="reference internal" href="writing_plugin.html#macro-import-types"><span class="std std-ref">MTS_IMPORT_TYPES(…)</span></a></p></li>
</ul>
</div>
<div class="section" id="branching-and-masking">
<h2>Branching and masking<a class="headerlink" href="#branching-and-masking" title="Permalink to this headline">¶</a></h2>
<p>When dealing with vectorized computational backends (e.g. <code class="docutils literal notranslate"><span class="pre">packet_*</span></code>,
<code class="docutils literal notranslate"><span class="pre">gpu_*</span></code>), additional scrutiny is needed to adapt C++ branching logic (in
particular, <code class="docutils literal notranslate"><span class="pre">if</span></code> statements).</p>
<p>Consider the result of a ray intersection in scalar mode. The resulting
<a class="reference internal" href="../../generated/render_api.html#mitsuba.render.SurfaceInteraction3f" title="mitsuba.render.SurfaceInteraction3f"><code class="xref py py-class docutils literal notranslate"><span class="pre">SurfaceInteraction3f</span></code></a> record holds information
concerning a single surface intersection. In this case, conditional logic works
fine using normal <code class="docutils literal notranslate"><span class="pre">if</span></code> statements.</p>
<p>On the other hand, the same data structure in a vectorized backend (e.g.
<code class="docutils literal notranslate"><span class="pre">gpu_rgb</span></code>) holds information concerning <em>many</em> surface intersections. Since
any condition may only be <span class="monosp">true</span> for a subset of the elements, conditionals
logic can no longer be carried out using ordinary <code class="docutils literal notranslate"><span class="pre">if</span></code> statements.</p>
<p>The alternative operation <code class="docutils literal notranslate"><span class="pre">enoki::select(mask,</span> <span class="pre">arg1,</span> <span class="pre">arg2)</span></code> takes a <em>mask</em>
argument (typically the result of a comparison) and evaluates <code class="docutils literal notranslate"><span class="pre">(mask</span> <span class="pre">?</span> <span class="pre">arg1</span> <span class="pre">:</span>
<span class="pre">arg2)</span></code> in parallel for each lane. We refer to <a class="reference external" href="https://enoki.readthedocs.io/en/master/basics.html#working-with-masks">Enoki’s documentation</a> for
further information on working with masks. The following shows an example
contrasting these two cases:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// --------------------</span>
<span class="c1">// Scalar code (discouraged)</span>

<span class="n">Scene</span> <span class="n">scene</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">Ray3f</span> <span class="n">ray</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">SurfaceInteraction3f</span> <span class="n">si</span> <span class="o">=</span> <span class="n">scene</span><span class="o">-&gt;</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="k">return</span> <span class="mf">1.f</span><span class="p">;</span>
<span class="k">else</span>
    <span class="k">return</span> <span class="mf">0.f</span><span class="p">;</span>

<span class="c1">// --------------------</span>
<span class="c1">// Generic code</span>

<span class="n">Scene</span> <span class="n">scene</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">Ray3f</span> <span class="n">ray</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">SurfaceInteraction3f</span> <span class="n">si</span> <span class="o">=</span> <span class="n">scene</span><span class="o">-&gt;</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">);</span>

<span class="k">return</span> <span class="n">enoki</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">is_valid</span><span class="p">(),</span> <span class="mf">1.0f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
</pre></div>
</div>
<p>Moreover, most of the functions/methods take an <em>optional</em> <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">active</span></code> parameter
that encodes which <em>lanes</em> remain active. In the example above, we can e.g.
provide this information to the <code class="docutils literal notranslate"><span class="pre">ray_intersect</span></code> routine to avoid computation
(particularly, memory reads) associated with invalid entries. The updated code
then reads:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Mask specifying the active lanes</span>
<span class="n">Mask</span> <span class="n">active</span> <span class="o">=</span> <span class="p">...;</span>

<span class="n">Scene</span> <span class="n">scene</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">Ray3f</span> <span class="n">ray</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">SurfaceInteraction3f</span> <span class="n">si</span> <span class="o">=</span> <span class="n">scene</span><span class="o">-&gt;</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>

<span class="k">return</span> <span class="n">enoki</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">si</span><span class="p">.</span><span class="n">is_valid</span><span class="p">(),</span> <span class="mf">1.0f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="cuda-backend-synchronization-point">
<h2>CUDA backend synchronization point<a class="headerlink" href="#cuda-backend-synchronization-point" title="Permalink to this headline">¶</a></h2>
<p>As described in Enoki’s documentation on <a class="reference external" href="https://enoki.readthedocs.io/en/master/gpu.html#suggestions-regarding-horizontal-operations">GPU arrays</a>,
the <code class="docutils literal notranslate"><span class="pre">gpu_*</span></code> computational backends rely on a JIT compiler that dynamically
generates kernels using NVIDIA’s PTX intermediate language. This JIT compiler
is highly efficient for <em>vertical</em> operations (additions, multiplications,
gathers, scatters, etc.).  However, applying a <em>horizontal</em> operations (e.g.
<code class="docutils literal notranslate"><span class="pre">enoki::any()</span></code>, <code class="docutils literal notranslate"><span class="pre">enoki::all()</span></code>, <code class="docutils literal notranslate"><span class="pre">enoki::hsum()</span></code>, etc.) to a
<code class="docutils literal notranslate"><span class="pre">CUDAArray&lt;T&gt;</span></code> will flush all currently queued computations, which limits the
amount of parallelism.</p>
<p>In many cases, horizontal mask-related operations can safely be skipped if this
yields a performance benefit. For this reason, the Mitsuba 2 codebase makes
frequent use of alternative reduction operations (<code class="docutils literal notranslate"><span class="pre">any_or&lt;&gt;()</span></code>,
<code class="docutils literal notranslate"><span class="pre">all_or&lt;&gt;()</span></code>, …) that skip evaluation on GPU targets.</p>
<p>For example, the code <code class="docutils literal notranslate"><span class="pre">...</span></code> in the example below will
only be executed if <code class="docutils literal notranslate"><span class="pre">condition</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> in <code class="docutils literal notranslate"><span class="pre">scalar_*</span></code> variants.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Mask</span> <span class="n">condition</span> <span class="o">=</span> <span class="p">...;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">any_or</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the case of <code class="docutils literal notranslate"><span class="pre">packet_*</span></code> variants, it will be executed if <em>at least one
element</em> of <code class="docutils literal notranslate"><span class="pre">condition</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>. In <code class="docutils literal notranslate"><span class="pre">gpu_*</span></code> variants, we are typically
working with arrays containing millions of elements, and it is quite likely
that at least of one of the array entries will in any case trigger execution of the
<code class="docutils literal notranslate"><span class="pre">...</span></code>. The <code class="docutils literal notranslate"><span class="pre">any_or&lt;true&gt;(condition)</span></code> then skips the costly horizontal reduction
and always assumes the condition to be true.</p>
</div>
<div class="section" id="pointer-types">
<h2>Pointer types<a class="headerlink" href="#pointer-types" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">MTS_IMPORT_TYPES</span></code> macro also imports variant-specific type aliases for
pointer types. This is important: for example, consider the <code class="docutils literal notranslate"><span class="pre">BSDF</span></code> associated
with a surface intersection. In a scalar variant , this is nicely represented
using a <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">BSDF</span> <span class="pre">*</span></code> pointer. However, on a vectorized variants (<code class="docutils literal notranslate"><span class="pre">gpu_*</span></code>,
<code class="docutils literal notranslate"><span class="pre">packet_*</span></code>), the intersection is in fact an array of many intersections, and
the simple pointer is therefore replaced by an <em>array of pointers*</em>. These
pointer aliases are used as follows:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Imports BSDFPtr, EmitterPtr, etc..</span>
<span class="n">MTS_IMPORT_TYPES</span><span class="p">()</span>

<span class="n">Scene</span> <span class="n">scene</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">Mask</span> <span class="n">active</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">Ray3f</span> <span class="n">ray</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">SurfaceInteraction3f</span> <span class="n">si</span> <span class="o">=</span> <span class="n">scene</span><span class="o">-&gt;</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>

<span class="c1">// Array of pointers if Float is an array</span>
<span class="n">BSDFPtr</span> <span class="n">bsdf</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="n">bsdf</span><span class="p">();</span>

<span class="c1">// Enoki is able to dispatch method calls involving arrays of pointers</span>
<span class="n">bsdf</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">(...,</span> <span class="n">active</span><span class="p">);</span>
</pre></div>
</div>
<p>More information on vectorized method calls is provided in the <a class="reference external" href="https://enoki.readthedocs.io/en/master/calls.html">Enoki
documentation</a>.</p>
</div>
<div class="section" id="variant-specific-code">
<h2>Variant-specific code<a class="headerlink" href="#variant-specific-code" title="Permalink to this headline">¶</a></h2>
<p>The C++17 <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">constexpr</span></code> statement is often used throughout the codebase to
restrict code fragments to specific variants. For instance the following C++
snippet converts a spectrum to an XYZ tristimulus value, which crucially
depends on the color representation of the variant being compiled.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Ray3f</span> <span class="n">ray</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">Mask</span> <span class="n">active</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">Spectrum</span> <span class="n">result</span> <span class="o">=</span> <span class="n">compute_stuff</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>

<span class="n">Color3f</span> <span class="n">xyz</span><span class="p">;</span>
<span class="k">if</span> <span class="nf">constexpr</span> <span class="p">(</span><span class="n">is_monochromatic_v</span><span class="o">&lt;</span><span class="n">Spectrum</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
<span class="k">else</span> <span class="k">if</span> <span class="k">constexpr</span> <span class="p">(</span><span class="n">is_rgb_v</span><span class="o">&lt;</span><span class="n">Spectrum</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">srgb_to_xyz</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
<span class="k">else</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">spectrum_to_xyz</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ray</span><span class="p">.</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">constexpr</span></code> is resolved at compile-time, this branch does not cause
any runtime overheads. Another useful feature of <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">constexpr</span></code> is that it
suppresses compilation errors in disabled branches. This makes it possible to
generic code that could potentially produce compilation errors when expressed
using ordinary (non-<code class="docutils literal notranslate"><span class="pre">constexpr</span></code>) <code class="docutils literal notranslate"><span class="pre">if</span></code> statements (for example, by accessing
a member of a class that may not exist in all variants).</p>
<p>Mitsuba provides various <em>type-traits</em> such as <code class="docutils literal notranslate"><span class="pre">is_monochromatic_v</span></code> to query
variant-specific properties. They can be found in
<code class="file docutils literal notranslate"><span class="pre">include/mitsuba/core/traits.h</span></code>.</p>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="intro.html" title="previous chapter (use the left arrow)">Introduction</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="writing_plugin.html" title="next chapter (use the right arrow)">Plugins &amp; Macros</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="writing_plugin.html" title="Plugins &amp; Macros"
             >next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Variants in C++</a></li> 
      </ul>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>